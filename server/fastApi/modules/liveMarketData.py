
from selectors import SelectorKey
from tokenize import Double

from anyio import sleep_forever
from coinmarketcapapi import CoinMarketCapAPI, CoinMarketCapAPIError
from datetime import datetime

COINMARKETCAP_API_KEY = '8ac04e5d-477c-44c4-a58e-3e4f82e3253f'


class Ticker:
    name = ""
    tickerId = ""
    currentPrice = 0.0

    def __init__(self, name: str, tickerId: str, currentPrice: Double):
        self.name = name
        self.tickerId = tickerId
        self.currentPrice = currentPrice

    def updatePrice(self, newPrice: Double):
        self.currentPrice = newPrice

    def getJsonData(self):
        return {"name": self.name,
                "id": self.tickerId,
                "price": self.currentPrice}


class LiveMarketData():
    data = {}
    cmc = CoinMarketCapAPI(COINMARKETCAP_API_KEY)
    lastFetched = datetime.now()

    def createOrUpdateTicker(self, name: str, tickerId: str, currentPrice: Double):
        if(tickerId in self.data):
            self.data[tickerId].updatePrice(currentPrice)
        else:
            self.data[tickerId] = Ticker(name, tickerId, currentPrice)

    def fetchAndUpdateLiveMarketData(self):
        # data = self.cmc.cryptocurrency_listings_latest(
        #     convert='INR', start=1, limit=10)
        fetched = [{'id': 1, 'name': 'Bitcoin', 'symbol': 'BTC', 'slug': 'bitcoin', 'num_market_pairs': 9138, 'date_added': '2013-04-28T00:00:00.000Z', 'tags': ['mineable', 'pow', 'sha-256', 'store-of-value', 'state-channel', 'coinbase-ventures-portfolio', 'three-arrows-capital-portfolio', 'polychain-capital-portfolio', 'binance-labs-portfolio', 'blockchain-capital-portfolio', 'boostvc-portfolio', 'cms-holdings-portfolio', 'dcg-portfolio', 'dragonfly-capital-portfolio', 'electric-capital-portfolio', 'fabric-ventures-portfolio', 'framework-ventures-portfolio', 'galaxy-digital-portfolio', 'huobi-capital-portfolio', 'alameda-research-portfolio', 'a16z-portfolio', '1confirmation-portfolio', 'winklevoss-capital-portfolio', 'usv-portfolio', 'placeholder-ventures-portfolio', 'pantera-capital-portfolio', 'multicoin-capital-portfolio', 'paradigm-portfolio'], 'max_supply': 21000000, 'circulating_supply': 18953775, 'total_supply': 18953775, 'platform': None, 'cmc_rank': 1, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 3315296.050681765, 'volume_24h': 1666148241508.4744, 'volume_change_24h': -26.1904, 'percent_change_1h': 0.15811604, 'percent_change_24h': 1.75452935, 'percent_change_7d': 17.60452505, 'percent_change_30d': 5.2641822, 'percent_change_60d': -9.81529156, 'percent_change_90d': -31.92055413, 'market_cap': 62837375403010.77, 'market_cap_dominance': 41.443, 'fully_diluted_market_cap': 69621217064316.836, 'last_updated': '2022-02-10T08:58:03.000Z'}}},
                   {'id': 1027, 'name': 'Ethereum', 'symbol': 'ETH', 'slug': 'ethereum', 'num_market_pairs': 5492, 'date_added': '2015-08-07T00:00:00.000Z', 'tags': ['mineable', 'pow', 'smart-contracts', 'ethereum-ecosystem', 'binance-smart-chain', 'coinbase-ventures-portfolio', 'three-arrows-capital-portfolio', 'polychain-capital-portfolio', 'binance-labs-portfolio', 'blockchain-capital-portfolio', 'boostvc-portfolio', 'cms-holdings-portfolio', 'dcg-portfolio', 'dragonfly-capital-portfolio', 'electric-capital-portfolio', 'fabric-ventures-portfolio', 'framework-ventures-portfolio', 'hashkey-capital-portfolio', 'kenetic-capital-portfolio', 'huobi-capital-portfolio', 'alameda-research-portfolio', 'a16z-portfolio', '1confirmation-portfolio', 'winklevoss-capital-portfolio', 'usv-portfolio', 'placeholder-ventures-portfolio', 'pantera-capital-portfolio', 'multicoin-capital-portfolio', 'paradigm-portfolio'], 'max_supply': None, 'circulating_supply': 119520137.124, 'total_supply': 119520137.124, 'platform': None, 'cmc_rank': 2, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 239833.68807184912, 'volume_24h': 1012203891978.6713, 'volume_change_24h': -8.6041, 'percent_change_1h': 0.09441623, 'percent_change_24h': 3.38855929, 'percent_change_7d': 18.01802983, 'percent_change_30d': 2.8222777, 'percent_change_60d': -20.30382632, 'percent_change_90d': -32.49343752, 'market_cap': 28664955285302.05, 'market_cap_dominance': 18.9064, 'fully_diluted_market_cap': 28664955285302.047, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 825, 'name': 'Tether', 'symbol': 'USDT', 'slug': 'tether', 'num_market_pairs': 27624, 'date_added': '2015-02-25T00:00:00.000Z', 'tags': ['payments', 'stablecoin', 'asset-backed-stablecoin', 'binance-smart-chain', 'avalanche-ecosystem', 'solana-ecosystem', 'moonriver-ecosystem'], 'max_supply': None, 'circulating_supply': 78034451118.84462, 'total_supply': 80074697052.59753, 'platform': {'id': 1027, 'name': 'Ethereum', 'symbol': 'ETH', 'slug': 'ethereum', 'token_address': '0xdac17f958d2ee523a2206206994597c13d831ec7'}, 'cmc_rank': 3, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 75.03429864084549, 'volume_24h': 4436585803804.827, 'volume_change_24h': -7.122, 'percent_change_1h': -0.17558974, 'percent_change_24h': 0.05066809, 'percent_change_7d': -1.35002455, 'percent_change_30d': 0.07661635, 'percent_change_60d': 0.08558981, 'percent_change_90d': -0.06289685, 'market_cap': 5855260309525.848, 'market_cap_dominance': 3.8623, 'fully_diluted_market_cap': 6008348732220.12, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 1839, 'name': 'BNB', 'symbol': 'BNB', 'slug': 'bnb', 'num_market_pairs': 677, 'date_added': '2017-07-25T00:00:00.000Z', 'tags': ['marketplace', 'centralized-exchange', 'payments', 'smart-contracts', 'binance-smart-chain', 'alameda-research-portfolio', 'multicoin-capital-portfolio', 'moonriver-ecosystem'], 'max_supply': 165116760, 'circulating_supply': 165116760.89, 'total_supply': 165116760.89, 'platform': None, 'cmc_rank': 4, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 31763.91356242753, 'volume_24h': 120419531680.31125, 'volume_change_24h': -22.8731, 'percent_change_1h': 0.3995293, 'percent_change_24h': 2.22609299, 'percent_change_7d': 13.08444249, 'percent_change_30d': -5.83987648, 'percent_change_60d': -25.04816163, 'percent_change_90d': -32.51761971, 'market_cap': 5244754520617.974, 'market_cap_dominance': 3.4596, 'fully_diluted_market_cap': 5244754492347.725, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 3408, 'name': 'USD Coin', 'symbol': 'USDC', 'slug': 'usd-coin', 'num_market_pairs': 2962, 'date_added': '2018-10-08T00:00:00.000Z', 'tags': ['medium-of-exchange', 'stablecoin', 'asset-backed-stablecoin', 'binance-smart-chain', 'fantom-ecosystem', 'moonriver-ecosystem'], 'max_supply': None, 'circulating_supply': 51952490779.92902, 'total_supply': 51952490779.92902, 'platform': {'id': 1027, 'name': 'Ethereum', 'symbol': 'ETH', 'slug': 'ethereum', 'token_address': '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48'}, 'cmc_rank': 5, 'self_reported_circulating_supply': None,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 74.97486512296798, 'volume_24h': 234398988724.80908, 'volume_change_24h': -6.6447, 'percent_change_1h': -0.17365926, 'percent_change_24h': 0.04300606, 'percent_change_7d': -1.44649551, 'percent_change_30d': -0.03352254, 'percent_change_60d': -0.1500687, 'percent_change_90d': -0.09627946, 'market_cap': 3895130989027.4165, 'market_cap_dominance': 2.5694, 'fully_diluted_market_cap': 3895130989027.2275, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 52, 'name': 'XRP', 'symbol': 'XRP', 'slug': 'xrp', 'num_market_pairs': 677, 'date_added': '2013-08-04T00:00:00.000Z', 'tags': ['medium-of-exchange', 'enterprise-solutions', 'binance-chain', 'arrington-xrp-capital-portfolio', 'galaxy-digital-portfolio', 'a16z-portfolio', 'pantera-capital-portfolio'], 'max_supply': 100000000000, 'circulating_supply': 47832461678, 'total_supply': 99989769444, 'platform': None, 'cmc_rank': 6, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 65.61096573613433, 'volume_24h': 280912117727.4282, 'volume_change_24h': -21.3242, 'percent_change_1h': 0.38485734, 'percent_change_24h': 2.70427755, 'percent_change_7d': 43.43102573, 'percent_change_30d': 17.8430515, 'percent_change_60d': 6.61797803, 'percent_change_90d': -27.62186309, 'market_cap': 3138334004230.2163, 'market_cap_dominance': 2.0699, 'fully_diluted_market_cap': 6561096573613.563, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 2010, 'name': 'Cardano', 'symbol': 'ADA', 'slug': 'cardano', 'num_market_pairs': 363, 'date_added': '2017-10-01T00:00:00.000Z', 'tags': ['mineable', 'dpos', 'pos', 'platform', 'research', 'smart-contracts', 'staking', 'binance-smart-chain', 'cardano-ecosystem', 'cardano'], 'max_supply': 45000000000, 'circulating_supply': 33592671729.531, 'total_supply': 34085668605.164, 'platform': None, 'cmc_rank': 7, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 89.06302509984957, 'volume_24h': 94469474063.05553, 'volume_change_24h': -26.0702, 'percent_change_1h': -0.17772773, 'percent_change_24h': 0.52334191, 'percent_change_7d': 12.60775381, 'percent_change_30d': 3.27409801, 'percent_change_60d': -10.85373276, 'percent_change_90d': -42.59797493, 'market_cap': 2991864965418.226, 'market_cap_dominance': 1.9733, 'fully_diluted_market_cap': 4007836129493.265, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 5426, 'name': 'Solana', 'symbol': 'SOL', 'slug': 'solana', 'num_market_pairs': 249, 'date_added': '2020-04-10T00:00:00.000Z', 'tags': ['pos', 'platform', 'solana-ecosystem', 'cms-holdings-portfolio', 'kenetic-capital-portfolio', 'alameda-research-portfolio', 'multicoin-capital-portfolio', 'okex-blockdream-ventures-portfolio'], 'max_supply': None, 'circulating_supply': 317464712.2957275, 'total_supply': 511616946.142289, 'platform': None, 'cmc_rank': 8, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 8442.739794506237, 'volume_24h': 151749559825.86032, 'volume_change_24h': -9.9693, 'percent_change_1h': 0.0808931, 'percent_change_24h': 1.28741594, 'percent_change_7d': 12.34584804, 'percent_change_30d': -17.56068727, 'percent_change_60d': -33.30253678, 'percent_change_90d': -51.33566038, 'market_cap': 2680271959850.612, 'market_cap_dominance': 1.7677, 'fully_diluted_market_cap': 4319448750739.268, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 4172, 'name': 'Terra', 'symbol': 'LUNA', 'slug': 'terra-luna', 'num_market_pairs': 146, 'date_added': '2019-07-26T00:00:00.000Z', 'tags': ['cosmos-ecosystem', 'store-of-value', 'defi', 'payments', 'coinbase-ventures-portfolio', 'binance-labs-portfolio', 'solana-ecosystem', 'arrington-xrp-capital-portfolio', 'hashkey-capital-portfolio', 'kenetic-capital-portfolio', 'huobi-capital-portfolio', 'pantera-capital-portfolio', 'terra-ecosystem'], 'max_supply': None, 'circulating_supply': 401363398.13884586, 'total_supply': 818512630.448533, 'platform': None, 'cmc_rank': 9, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 4218.277280312396, 'volume_24h': 115894871915.42587, 'volume_change_24h': -1.684, 'percent_change_1h': -0.1454607, 'percent_change_24h': 2.56455015, 'percent_change_7d': 13.7299975, 'percent_change_30d': -22.66842241, 'percent_change_60d': -3.95464414, 'percent_change_90d': 14.74579482, 'market_cap': 1693062103518.0723, 'market_cap_dominance': 1.1168, 'fully_diluted_market_cap': 3452713232669.852, 'last_updated': '2022-02-10T08:58:03.000Z'}}}, {'id': 5805, 'name': 'Avalanche', 'symbol': 'AVAX', 'slug': 'avalanche', 'num_market_pairs': 189, 'date_added': '2020-07-13T00:00:00.000Z', 'tags': ['defi', 'smart-contracts', 'binance-smart-chain', 'polychain-capital-portfolio', 'avalanche-ecosystem', 'cms-holdings-portfolio', 'dragonfly-capital-portfolio', 'moonriver-ecosystem'], 'max_supply': None, 'circulating_supply': 245282553.44228858, 'total_supply': 395891289.9134107, 'platform': None, 'cmc_rank': 10, 'self_reported_circulating_supply': None, 'self_reported_market_cap': None, 'last_updated': '2022-02-10T08:57:00.000Z', 'quote': {'INR': {'price': 6725.968188830853, 'volume_24h': 77664322713.79634, 'volume_change_24h': -41.2894, 'percent_change_1h': -0.4453625, 'percent_change_24h': 1.57121977, 'percent_change_7d': 30.71040763, 'percent_change_30d': 4.25643214, 'percent_change_60d': 6.35678718, 'percent_change_90d': 4.08305157, 'market_cap': 1649762651728.0366, 'market_cap_dominance': 1.0881, 'fully_diluted_market_cap': 2662752222192.984, 'last_updated': '2022-02-10T08:58:03.000Z'}}}]
        for ticker in fetched:
            self.createOrUpdateTicker(
                ticker["name"], ticker["symbol"], ticker["quote"]["INR"]["price"])
        self.lastFetched = datetime.now()

    def getTickersData(self, ticker: list[str]):
        if((datetime.now() - self.lastFetched).total_seconds() > 900):
            self.fetchAndUpdateLiveMarketData()
        return [self.data[val].getJsonData() for val in ticker if val in self.data]


if __name__ == '__main__':
    liveMarketData = LiveMarketData()
    liveMarketData.fetchAndUpdateLiveMarketData()
    print(liveMarketData.getTickersData(["BTC", "XRP", "ABC"]))
